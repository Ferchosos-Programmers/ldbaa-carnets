<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Registro de Jugador | Liga Barrial</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="icon" href="img/logo.png">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-firestore.js"></script>

    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Font Awesome para los iconos -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link rel="stylesheet" href="css/responsive.css" />
    <link rel="stylesheet" href="css/registro.css" />
  </head>
  <body>
    <!-- Header -->
    <nav class="navbar navbar-expand-lg shadow-sm px-4">
      <div class="container-fluid">
        <a
          class="navbar-brand text-white fw-bold d-flex align-items-center"
          href="#"
        >
          <img
            src="img/logo.png"
            alt="Logo"
            width="30"
            height="30"
            class="me-2"
          />
          LIGA BARRIAL ARGELIA ALTA
        </a>
        <button
          class="btn btn-outline-light"
          onclick="window.history.back()"
        >
          <i class="fas fa-arrow-left me-2"></i>Regresar
        </button>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="row">
        <!-- Formulario de registro -->
        <div class="col-md-6">
          <div class="card">
            <div class="card-body">
              <h4 class="card-title mb-4" id="formTitle" style="text-align: center;">Registro de Jugador</h4>
              <form id="playerForm">
                <div id="playerSelectorContainer" class="mb-3" style="display: none;">
                  <label for="playerSelector" class="form-label">Seleccionar Jugador a Recalificar</label>
                  <select class="form-select" id="playerSelector">
                    <option value="">Seleccione un jugador</option>
                  </select>
                </div>

                <!-- Formulario del jugador actual -->
                <div id="currentPlayerForm" style="display: none;">
                  <h5 class="mb-3">Datos del Jugador Actual</h5>
                  <div class="mb-3">
                    <label for="currentTeamName" class="form-label">Equipo</label>
                    <input type="text" class="form-control" id="currentTeamName" readonly />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Foto del Jugador</label>
                    <div class="preview-container mt-2">
                      <img id="currentPlayerPhotoPreview" class="preview-image carnet-photo" alt="Foto del jugador actual" style="max-width: 120px; height: 190px" />
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="currentNombres" class="form-label">Nombres</label>
                    <input type="text" class="form-control" id="currentNombres" readonly />
                  </div>
                  <div class="mb-3">
                    <label for="currentApellidos" class="form-label">Apellidos</label>
                    <input type="text" class="form-control" id="currentApellidos" readonly />
                  </div>
                  <div class="mb-3">
                    <label for="currentCedula" class="form-label">Número de Cédula</label>
                    <input type="text" class="form-control" id="currentCedula" readonly />
                  </div>
                  <div class="mb-3">
                    <label for="currentFechaNacimiento" class="form-label">Fecha de Nacimiento</label>
                    <input type="date" class="form-control" id="currentFechaNacimiento" readonly />
                  </div>
                  <div class="mb-3">
                    <label for="currentNumeroJugador" class="form-label">Número de Jugador</label>
                    <input type="number" class="form-control" id="currentNumeroJugador" readonly />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Foto de la Cédula</label>
                    <div class="preview-container mt-2">
                      <img id="currentCedulaPhotoPreview" class="preview-image cedula-photo" alt="Foto de la cédula actual" style="max-height: 250px" />
                    </div>
                  </div>
                </div>

                <!-- Formulario del nuevo jugador -->
                <div id="newPlayerForm" style="display: none;">
                  <h5 class="mb-3 mt-4">Datos del Nuevo Jugador</h5>
                  
                  <div class="mb-3">
                    <label for="teamName" class="form-label">Equipo</label>
                    <input type="text" class="form-control" id="teamName" readonly />
                  </div>
                  <div class="mb-3">
                    <label for="playerPhoto" class="form-label">Foto del Jugador (Tamaño Carnet)</label>
                    <input type="file" class="form-control" id="playerPhoto" accept="image/*" required />
                    <div class="photo-dimensions">Dimensiones recomendadas: 300x400 píxeles</div>
                    <div class="preview-container mt-2">
                      <img id="playerPhotoPreview" class="preview-image carnet-photo d-none" alt="Vista previa de la foto" />
                      <p class="text-muted mb-0" id="playerPhotoText">Vista previa de la foto</p>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="nombres" class="form-label">Nombres</label>
                    <input type="text" class="form-control" id="nombres" required />
                  </div>
                  <div class="mb-3">
                    <label for="apellidos" class="form-label">Apellidos</label>
                    <input type="text" class="form-control" id="apellidos" required />
                  </div>
                  <div class="mb-3">
                    <label for="cedula" class="form-label">Número de Cédula</label>
                    <input type="text" class="form-control" id="cedula" required />
                  </div>
                  <div class="mb-3">
                    <label for="fechaNacimiento" class="form-label">Fecha de Nacimiento</label>
                    <input type="date" class="form-control" id="fechaNacimiento" required />
                  </div>
                  <div class="mb-3">
                    <label for="numeroJugador" class="form-label">Número de Jugador</label>
                    <input type="number" class="form-control" id="numeroJugador" required />
                  </div>
                  <div class="mb-3">
                    <label for="cedulaPhoto" class="form-label">Foto de la Cédula</label>
                    <input type="file" class="form-control" id="cedulaPhoto" accept="image/*" required />
                    <div class="photo-dimensions">Dimensiones recomendadas: 400x250 píxeles</div>
                    <div class="preview-container mt-2">
                      <img id="cedulaPhotoPreview" class="preview-image cedula-photo d-none" alt="Vista previa de la cédula" />
                      <p class="text-muted mb-0" id="cedulaPhotoText">Vista previa de la cédula</p>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="campeonato" class="form-label">Campeonato</label>
                    <select class="form-select" id="campeonato">
                      <option value="">Seleccione un campeonato</option>
                    </select>
                  </div>
                  <button type="submit" class="btn btn-success w-100" id="submitButton">
                    Registrar Nuevo Jugador
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Lista de jugadores registrados -->
        <div class="col-md-6">
          <div class="card">
            <div class="card-body">
              <div
                class="d-flex justify-content-between align-items-center mb-4"
              >
                <h4 class="card-title mb-0" id="playersListTitle">Jugadores Registrados</h4>
                <button class="btn btn-primary" onclick="generarCarnets()">
                  <i class="fas fa-id-card me-2"></i>Generar Carnets
                </button>
              </div>
              
              <!-- Contador de jugadores y cupo -->
              <div class="cupo-info mb-4">
                <div class="row">
                  <div class="col-md-4">
                    <div class="cupo-card bg-light p-3 rounded">
                      <h6 class="text-primary mb-2">
                        <i class="fas fa-users me-2"></i> Jugadores Senior
                      </h6> 
                      <div class="d-flex justify-content-between align-items-center">
                        <span class="h4 mb-0" id="jugadoresRegularesCount">0</span>
                        <!-- <span class="text-muted">/ 25</span> -->
                      </div>
                      <div class="progress mt-2" style="height: 8px;">
                        <div class="progress-bar bg-primary" id="jugadoresRegularesProgress" style="width: 0%"></div>
                      </div>
                      <small class="text-muted" id="jugadoresRegularesStatus">Cupo disponible</small>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="cupo-card bg-light p-3 rounded">
                      <h6 class="text-success mb-2">
                        <i class="fas fa-child me-2"></i>Jugadores <15 
                      </h6>
                      <div class="d-flex justify-content-between align-items-center">
                        <span class="h4 mb-0" id="jugadoresJuvenilesCount">0</span>
                        <!-- <span class="text-muted">/ 2</span> -->
                      </div>
                      <div class="progress mt-2" style="height: 8px;">
                        <div class="progress-bar bg-success" id="jugadoresJuvenilesProgress" style="width: 0%"></div>
                      </div>
                      <small class="text-muted" id="jugadoresJuvenilesStatus">Cupo disponible</small>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="cupo-card bg-info p-3 rounded text-white">
                      <h6 class="mb-2">
                        <i class="fas fa-trophy me-2"></i>Máximo Total
                      </h6>
                      <div class="d-flex justify-content-between align-items-center">
                        <span class="h4 mb-0" id="jugadoresTotalCount">0</span>
                        <!-- <span>/ 27</span> -->
                      </div>
                      <div class="progress mt-2" style="height: 8px; background-color: rgba(255,255,255,0.3);">
                        <div class="progress-bar bg-white" id="jugadoresTotalProgress" style="width: 0%"></div>
                      </div>
                      <small id="jugadoresTotalStatus">Cupo disponible</small>
                    </div>
                  </div>
                </div>
                
              
                <!-- Contador de jugadores recalificados (solo visible en modo reclassify) -->
                <div id="recalificadosCounter" class="mt-3" style="display: none;">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="cupo-card bg-warning p-3 rounded text-dark">
                        <h6 class="mb-2">
                          <i class="fas fa-exchange-alt me-2"></i>Jugadores Recalificados
                        </h6>
                        <div class="d-flex justify-content-between align-items-center">
                          <span class="h4 mb-0" id="jugadoresRecalificadosCount">0</span>
                        </div>
                        <div class="progress mt-2" style="height: 8px; background-color: rgba(0,0,0,0.2);">
                          <div class="progress-bar bg-warning" id="jugadoresRecalificadosProgress" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="jugadoresRecalificadosStatus">Jugadores marcados como recalificados</small>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="cupo-card bg-danger p-3 rounded text-white">
                        <h6 class="mb-2">
                          <i class="fas fa-user-plus me-2"></i>Nuevos Jugadores
                        </h6>
                        <div class="d-flex justify-content-between align-items-center">
                          <span class="h4 mb-0" id="jugadoresNuevosCount">0</span>
                        </div>
                        <div class="progress mt-2" style="height: 8px; background-color: rgba(255,255,255,0.3);">
                          <div class="progress-bar bg-white" id="jugadoresNuevosProgress" style="width: 0%"></div>
                        </div>
                        <small id="jugadoresNuevosStatus">Jugadores que reemplazaron a recalificados</small>
                      </div>
                    </div>
                  </div>
                </div>

                 <!-- Contador de total de jugadores registrados -->
                 <div class="row mt-3">
                  <div class="col-md-12">
                    <div class="cupo-card bg-dark p-3 rounded text-white">
                      <h6 class="mb-2">
                        <i class="fas fa-clipboard-list me-2"></i>Total de Jugadores Registrados
                      </h6>
                      <div class="d-flex justify-content-between align-items-center">
                        <span class="h4 mb-0" id="jugadoresRegistradosTotalCount">0</span>
                        <span class="text-light">(Senior + <15 + Recalificados)</span>
                      </div>
                      <div class="progress mt-2" style="height: 8px; background-color: rgba(255,255,255,0.3);">
                        <div class="progress-bar bg-warning" id="jugadoresRegistradosTotalProgress" style="width: 0%"></div>
                      </div>
                      <small id="jugadoresRegistradosTotalStatus">Total de jugadores en el equipo</small>
                    </div>
                  </div>
                </div>
                
                <div class="alert alert-info mt-3" id="cupoAlert" style="display: none;">
                  <i class="fas fa-info-circle me-2"></i>
                  <span id="cupoAlertText"></span>
                </div>
              </div>
              
              <div id="playersList" class="player-list">
                <!-- Los jugadores se cargarán aquí dinámicamente -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para ver detalles del jugador -->
    <div
      class="modal fade"
      id="playerModal"
      tabindex="-1"
      aria-labelledby="playerModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-xl w-100" style="max-width: 1000px">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="playerModalLabel">
              Documentos del Jugador
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div
              class="document-container d-flex justify-content-center align-items-center flex-wrap gap-4"
            >
              <!-- Carnet -->
              <div class="carnet-container">
                <div class="carnet-content">
                  <div class="carnet-header">
                    <h3 class="carnet-title">LIGA BARRIAL ARGELIA ALTA</h3>
                    <p class="carnet-subtitle">CAMPEONATO 2025</p>
                  </div>
                  <div class="d-flex justify-content-center">
                    <img
                      id="modalPlayerPhoto"
                      class="carnet-photo"
                      alt="Foto del jugador"
                      style="max-width: 120px; height: 190px"
                    />
                  </div>

                  <div class="carnet-info">
                    <p>
                      <strong>NOMBRE:</strong>
                      <span id="modalPlayerName"></span>
                    </p>
                    <p>
                      <strong>APELLIDO:</strong>
                      <span id="modalPlayerApellido"></span>
                    </p>
                    <p>
                      <strong>CÉDULA:</strong>
                      <span id="modalPlayerCedula"></span>
                    </p>
                    <p>
                      <strong>EQUIPO:</strong> <span id="modalTeamName"></span>
                    </p>
                    <p>
                      <strong>CATEGORÍA:</strong>
                      <span id="modalTeamCategory"></span>
                    </p>
                    <p>
                      <strong>NUMERO:</strong>
                      <span id="modalPlayerNumero"></span>
                    </p>
                    <p>
                      <strong>FECHA NAC:</strong>
                      <span id="modalPlayerFechaNacimiento"></span>
                    </p>
                  </div>
                  <div class="carnet-footer">
                    <p class="mb-0">
                      Documento oficial de la Liga Barrial Argelia Alta
                    </p>
                  </div>
                </div>
              </div>

              <!-- Cédula -->
              <div class="cedula-container" style="margin-top: -2%">
                <div class="cedula-content">
                  <div class="cedula-header">
                    <h3 class="carnet-title">LIGA BARRIAL ARGELIA ALTA</h3>
                    <p class="carnet-subtitle">DOCUMENTO DE IDENTIDAD</p>
                  </div>
                  <div
                    class="d-flex justify-content-center"
                    style="margin-top: 15%"
                  >
                    <img
                      id="modalCedulaPhoto"
                      class="cedula-photo"
                      alt="Foto de la cédula"
                      style="max-height: 250px"
                    />
                  </div>

                  <div
                    class="cedula-info"
                    style="margin-top: 10%; margin-bottom: 10%"
                  >
                    <p>
                      <strong>Número de Cédula:</strong>
                      <span id="modalCedulaNumber"></span>
                    </p>
                  </div>
                  <div class="cedula-footer">
                    <p class="mb-0">Documento de identificación oficial</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal para carnets generados -->
    <div
      class="modal fade"
      id="carnetsModal"
      tabindex="-1"
      aria-labelledby="carnetsModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-xl w-100" style="max-width: 1000px">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="carnetsModalLabel">
              Carnets de Jugadores
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="carnetsContainer" class="row">
              <!-- Los carnets se generarán aquí -->
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-info me-2"
              onclick="cambiarFondoCarnet()"
            >
              <i class="fas fa-image me-2"></i>Cambiar Fondo
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cerrar
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="imprimirCarnets()"
            >
              <i class="fas fa-print me-2"></i>Imprimir Carnets
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Configuración de Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyAzRTlx96sL8rxcgLauftrTWpr5VlwjV00",
        authDomain: "ldbaa-calificaciones.firebaseapp.com",
        projectId: "ldbaa-calificaciones",
        storageBucket: "ldbaa-calificaciones.firebasestorage.app",
        messagingSenderId: "277579489603",
        appId: "1:277579489603:web:bc93c22fea5f5f6b63cff6",
      };

      // Inicializar Firebase
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const db = firebase.firestore();

      let currentChampionshipId = null; // Variable para almacenar el ID del campeonato actual

      // Obtener el ID del equipo y el tipo de acción de la URL
      const urlParams = new URLSearchParams(window.location.search);
      const teamId = urlParams.get("teamId");
      const mode = urlParams.get("mode"); // Cambiado de action a mode

      // Actualizar el título según la acción
      if (mode === "reclassify") {
        document.title = "Recalificación de Jugador | Liga Barrial";
        document.getElementById("formTitle").textContent = "Recalificación de Jugador";
        document.getElementById("playersListTitle").textContent = "Jugadores Recalificados";
        document.getElementById("playerSelectorContainer").style.display = "block";
        document.getElementById("playerSelector").setAttribute("required", "");
        document.getElementById("submitButton").textContent = "Recalificar Jugador";
        document.getElementById("campeonato").closest(".mb-3").style.display = "none"; // Ocultar el campo de campeonato
        document.getElementById("recalificadosCounter").style.display = "block"; // Mostrar contador de recalificados
        loadPlayersForRecalification();
      } else {
        document.title = "Registro de Jugador | Liga Barrial";
        document.getElementById("formTitle").textContent = "Registro de Jugador";
        document.getElementById("playersListTitle").textContent = "Jugadores Calificados";
        document.getElementById("playerSelectorContainer").style.display = "none";
        document.getElementById("playerSelector").removeAttribute("required"); // Asegurarse de que no sea requerido en modo registro
        document.getElementById("submitButton").textContent = "Registrar Jugador";
        document.getElementById("campeonato").closest(".mb-3").style.display = "block"; // Mostrar el campo de campeonato
        document.getElementById("currentPlayerForm").style.display = "none"; // Ocultar formulario del jugador actual
        document.getElementById("newPlayerForm").style.display = "block"; // Mostrar formulario del nuevo jugador
        document.getElementById("recalificadosCounter").style.display = "none"; // Ocultar contador de recalificados
      }

      // Función para solicitar la clave de administrador
      function solicitarClaveAdmin() {
        return Swal.fire({
          title: "Configuración Inicial",
          text: "Por favor, establece una clave de administrador. Esta clave será necesaria para eliminar registros.",
          input: "password",
          inputAttributes: {
            autocapitalize: "off",
          },
          showCancelButton: true,
          confirmButtonText: "Establecer",
          cancelButtonText: "Cancelar",
          showLoaderOnConfirm: true,
          preConfirm: (password) => {
            if (!password) {
              Swal.showValidationMessage("Por favor ingresa una clave");
              return false;
            }
            return password;
          },
        });
      }

      // Verificar si ya existe una clave de administrador
      let adminKey = localStorage.getItem("adminKey");

      // Si no hay clave o no hay teamId, solicitar la clave
      if (!adminKey || !teamId) {
        solicitarClaveAdmin().then((result) => {
          if (result.isConfirmed) {
            adminKey = result.value;
            localStorage.setItem("adminKey", adminKey);

            // Guardar la clave en el documento del equipo
            if (teamId) {
              db.collection("teams")
                .doc(teamId)
                .update({
                  adminKey: adminKey,
                })
                .then(() => {
                  Swal.fire({
                    title: "¡Clave establecida!",
                    text: "Tu clave de administrador ha sido guardada.",
                    icon: "success",
                    confirmButtonColor: "#28a745",
                  });
                })
                .catch((error) => {
                  console.error("Error al guardar la clave:", error);
                  Swal.fire(
                    "Error",
                    "No se pudo guardar la clave. Por favor, intenta de nuevo.",
                    "error"
                  );
                });
            }
          }
        });
      } else {
        // Si ya existe una clave, verificar si coincide con la del equipo
        if (teamId) {
          db.collection("teams")
            .doc(teamId)
            .get()
            .then((doc) => {
              if (doc.exists) {
                const teamData = doc.data();
                if (!teamData.adminKey) {
                  // Si el equipo no tiene clave, solicitar una nueva
                  solicitarClaveAdmin().then((result) => {
                    if (result.isConfirmed) {
                      adminKey = result.value;
                      localStorage.setItem("adminKey", adminKey);
                      db.collection("teams").doc(teamId).update({
                        adminKey: adminKey,
                      });
                    }
                  });
                } else if (teamData.adminKey !== adminKey) {
                  // Si la clave no coincide, actualizar con la del equipo
                  adminKey = teamData.adminKey;
                  localStorage.setItem("adminKey", adminKey);
                }
              }
            });
        }
      }

      // Cargar información del equipo
      if (teamId) {
        db.collection("teams")
          .doc(teamId)
          .get()
          .then(async (doc) => {
            if (doc.exists) {
              const teamData = doc.data();
              document.getElementById("teamName").value = teamData.name;

              // Mostrar información del equipo en la parte superior
              const teamInfo = document.createElement("div");
              teamInfo.className = "text-center mb-4";
              teamInfo.innerHTML = `
                <img src="${teamData.logo}" class="img-fluid mb-3" style="max-height: 100px; object-fit: contain;" alt="Logo del equipo">
                <h4 class="mb-1">${teamData.name}</h4>
                <p class="text-muted mb-0">${teamData.category}</p>
              `;
              document
                .querySelector(".card-body")
                .insertBefore(
                  teamInfo,
                  document.querySelector(".card-body h4")
                );
            }
          })
          .catch((error) => {
            console.error("Error al cargar el equipo:", error);
            Swal.fire(
              "Error",
              "No se pudo cargar la información del equipo",
              "error"
            );
          });
      }

      // Cargar lista de jugadores
      function loadPlayers() {
        console.log("Iniciando carga de jugadores para el equipo:", teamId);
        if (teamId) {
          db.collection("players")
            .where("teamId", "==", teamId)
            .get()
            .then((querySnapshot) => {
              console.log("Jugadores cargados:", querySnapshot.size);
              const playersList = document.getElementById("playersList");
              playersList.innerHTML = "";

              if (querySnapshot.empty) {
                playersList.innerHTML =
                  '<div class="text-center text-muted">No hay jugadores registrados</div>';
                // Actualizar contador con lista vacía
                actualizarContadorCupo([]);
                return;
              }

              const jugadores = [];
              const jugadoresFiltrados = [];
              
              querySnapshot.forEach((doc) => {
                const player = doc.data();
                jugadores.push(player);
                
                // Filtrar jugadores según el modo
                if (mode === "reclassify") {
                  // En modo reclassify, solo mostrar jugadores recalificados
                  if (player.status === "recalificado") {
                    jugadoresFiltrados.push({...player, docId: doc.id});
                  }
                } else {
                  // En modo register, mostrar todos menos los nuevos que reemplazaron a recalificados
                  if (!player.reemplazoDe) {
                    jugadoresFiltrados.push({...player, docId: doc.id});
                  }
                }
              });
              
              // Mostrar mensaje si no hay jugadores según el filtro
              if (jugadoresFiltrados.length === 0) {
                if (mode === "reclassify") {
                  playersList.innerHTML = '<div class="text-center text-muted">No hay jugadores recalificados</div>';
                } else {
                  playersList.innerHTML = '<div class="text-center text-muted">No hay jugadores calificados</div>';
                }
                // Actualizar contador con lista vacía pero mantener todos los jugadores para el cálculo
                actualizarContadorCupo(jugadores);
                return;
              }
              
              // Mostrar jugadores filtrados
              if (mode === "reclassify") {
                jugadoresFiltrados.forEach((player) => {
                  // Buscar la jugadora nueva que reemplazó a esta recalificada
                  let nueva = jugadores.find(j => j.reemplazoDe === player.docId);

                  // Si no la encuentra por reemplazoDe, intenta buscar por recalificadoPor
                  if (!nueva && player.recalificadoPor) {
                    nueva = jugadores.find(j => j.docId === player.recalificadoPor);
                  }

                  if (nueva) {
                    // Contenedor flex para ambas tarjetas
                    const flexRow = document.createElement("div");
                    flexRow.className = "d-flex gap-3 mb-3 align-items-stretch";
                    flexRow.innerHTML = `
                      <div class="player-card flex-fill">
                        <div class="d-flex align-items-center p-3 bg-white rounded shadow-sm h-100">
                          <img src="${player.playerPhoto}" alt="Foto del jugador" class="rounded me-3" style="width: 50px; height: 50px; object-fit: cover;">
                          <div class="flex-grow-1">
                            <h6 class="mb-0">${player.nombres} ${player.apellidos}</h6>
                            <small class="text-muted">Cédula: ${player.cedula}</small>
                            <br><small class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Recalificado</small>
                          </div>
                          <div class="ms-3">
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="viewPlayerDetails('${player.docId}')">
                              <i class="fas fa-eye"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                      <div class="player-card flex-fill">
                        <div class="d-flex align-items-center p-3 bg-light rounded shadow-sm border border-success h-100">
                          <img src="${nueva.playerPhoto}" alt="Foto del jugador" class="rounded me-3" style="width: 50px; height: 50px; object-fit: cover;">
                          <div class="flex-grow-1">
                            <h6 class="mb-0">${nueva.nombres} ${nueva.apellidos}</h6>
                            <small class="text-muted">Cédula: ${nueva.cedula}</small>
                            <br><small class="text-success"><i class="fas fa-user-plus me-1"></i>Nuevo jugador que reemplaza</small>
                          </div>
                          <div class="ms-3">
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="viewPlayerDetails('${nueva.docId}')">
                              <i class="fas fa-eye"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    `;
                    playersList.appendChild(flexRow);
                  } else {
                    // Solo recalificado si no hay nuevo
                    const playerCard = document.createElement("div");
                    playerCard.className = "player-card mb-3";
                    playerCard.innerHTML = `
                      <div class="d-flex align-items-center p-3 bg-white rounded shadow-sm">
                        <img src="${player.playerPhoto}" alt="Foto del jugador" class="rounded me-3" style="width: 50px; height: 50px; object-fit: cover;">
                        <div class="flex-grow-1">
                          <h6 class="mb-0">${player.nombres} ${player.apellidos}</h6>
                          <small class="text-muted">Cédula: ${player.cedula}</small>
                          <br><small class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Recalificado</small>
                        </div>
                        <div class="ms-3">
                          <button class="btn btn-sm btn-outline-primary me-2" onclick="viewPlayerDetails('${player.docId}')">
                            <i class="fas fa-eye"></i>
                          </button>
                          ${player.status !== "recalificado" ? `<button class="btn btn-sm btn-outline-danger" onclick="deletePlayer('${player.docId}')">
                            <i class="fas fa-trash"></i>
                          </button>` : ''}
                        </div>
                      </div>
                    `;
                    playersList.appendChild(playerCard);
                  }
                });
              } else {
                jugadoresFiltrados.forEach((player) => {
                  const playerCard = document.createElement("div");
                  playerCard.className = "player-card mb-3";
                  playerCard.innerHTML = `
                    <div class="d-flex align-items-center p-3 bg-white rounded shadow-sm">
                      <img src="${player.playerPhoto}" alt="Foto del jugador" class="rounded me-3" style="width: 50px; height: 50px; object-fit: cover;">
                      <div class="flex-grow-1">
                        <h6 class="mb-0">${player.nombres} ${player.apellidos}</h6>
                        <small class="text-muted">Cédula: ${player.cedula}</small>
                        ${player.status === "recalificado" ? '<br><small class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Recalificado</small>' : ''}
                      </div>
                      <div class="ms-3">
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="viewPlayerDetails('${player.docId}')">
                          <i class="fas fa-eye"></i>
                        </button>
                        ${player.status !== "recalificado" ? `<button class="btn btn-sm btn-outline-danger" onclick="deletePlayer('${player.docId}')">
                          <i class="fas fa-trash"></i>
                        </button>` : ''}
                      </div>
                    </div>
                  `;
                  playersList.appendChild(playerCard);
                });
              }
              
              // Actualizar contador de cupo
              actualizarContadorCupo(jugadores);
            })
            .catch((error) => {
              console.error("Error al cargar jugadores:", error);
              Swal.fire(
                "Error",
                "No se pudieron cargar los jugadores",
                "error"
              );
            });
        }
      }

      // Cargar jugadores y campeonatos al iniciar
      document.addEventListener("DOMContentLoaded", () => {
        loadPlayers();
        loadCampeonatos();
      });

      // Función para cargar los campeonatos
      function loadCampeonatos() {
        db.collection("championships")
          .get()
          .then((querySnapshot) => {
            const campeonatoSelect = document.getElementById("campeonato");
            campeonatoSelect.innerHTML = '<option value="">Seleccione un campeonato</option>';
            querySnapshot.forEach((doc) => {
              const campeonato = doc.data();
              const option = document.createElement("option");
              option.value = doc.id;
              option.textContent = campeonato.name;
              campeonatoSelect.appendChild(option);
            });
          })
          .catch((error) => {
            console.error("Error al cargar campeonatos:", error);
            Swal.fire("Error", "No se pudieron cargar los campeonatos", "error");
          });
      }

      // Función para eliminar un jugador
      function deletePlayer(playerId) {
        // Verificar si el cupo está completo
        if (window.cupoCompleto) {
          Swal.fire({
            title: "Cupo Completo",
            text: "Tu equipo ya tiene el máximo de 27 jugadores permitidos. No puedes eliminar jugadores.",
            icon: "warning",
            confirmButtonColor: "#28a745",
          });
          return;
        }

        Swal.fire({
          title: "Ingresa la clave de administrador",
          input: "password",
          inputAttributes: {
            autocapitalize: "off",
          },
          showCancelButton: true,
          confirmButtonText: "Eliminar",
          cancelButtonText: "Cancelar",
          showLoaderOnConfirm: true,
          preConfirm: (password) => {
            if (!password) {
              Swal.showValidationMessage("Por favor ingresa la clave");
              return false;
            }
            if (password !== adminKey) {
              Swal.showValidationMessage("Clave incorrecta");
              return false;
            }
            return password;
          },
        }).then((result) => {
          if (result.isConfirmed) {
            db.collection("players")
              .doc(playerId)
              .delete()
              .then(() => {
                Swal.fire(
                  "Eliminado!",
                  "El jugador ha sido eliminado correctamente.",
                  "success"
                );
                loadPlayers();
              })
              .catch((error) => {
                console.error("Error al eliminar jugador:", error);
                Swal.fire(
                  "Error",
                  "No se pudo eliminar el jugador. Por favor, intenta de nuevo.",
                  "error"
                );
              });
          }
        });
      }

      // Previsualización de imágenes
      function setupImagePreview(
        inputId,
        previewId,
        textId,
        expectedWidth,
        expectedHeight
      ) {
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);
        const text = document.getElementById(textId);

        input.addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              const img = new Image();
              img.onload = function () {
                // Verificar dimensiones
                if (
                  Math.abs(img.width - expectedWidth) > 50 ||
                  Math.abs(img.height - expectedHeight) > 50
                ) {
                  Swal.fire({
                    title: "Advertencia",
                    text: `La imagen debe tener dimensiones aproximadas de ${expectedWidth}x${expectedHeight} píxeles. La imagen actual es de ${img.width}x${img.height} píxeles.`,
                    icon: "warning",
                    confirmButtonColor: "#28a745",
                  });
                }

                preview.src = e.target.result;
                preview.classList.remove("d-none");
                text.classList.add("d-none");
              };
              img.src = e.target.result;
            };
            reader.readAsDataURL(file);
          }
        });
      }

      setupImagePreview(
        "playerPhoto",
        "playerPhotoPreview",
        "playerPhotoText",
        300,
        400
      );
      setupImagePreview(
        "cedulaPhoto",
        "cedulaPhotoPreview",
        "cedulaPhotoText",
        400,
        250
      );

      // Manejar el envío del formulario
      document.getElementById("playerForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        // Solo bloquear por cupo completo en modo register
        if (window.cupoCompleto && mode === "register") {
          Swal.fire({
            title: "Cupo Completo",
            text: "Tu equipo ya tiene el máximo de 27 jugadores permitidos. No puedes registrar más jugadores.",
            icon: "warning",
            confirmButtonColor: "#28a745",
          });
          return;
        }

        // Validar el tipo de jugador antes de procesar
        const fechaNacValidacion = document.getElementById("fechaNacimiento").value;
        if (fechaNacValidacion) {
          const esJuvenil = esJuvenilMenor15(fechaNacValidacion);
          
          if (esJuvenil && window.cupoJuvenilesCompleto && window.cupoRegularesCompleto) {
            Swal.fire({
              title: "Cupo Completo",
              text: "Ya tienes el máximo de jugadores permitidos. No puedes registrar más jugadores.",
              icon: "warning",
              confirmButtonColor: "#28a745",
            });
            return;
          } else if (!esJuvenil && window.cupoRegularesCompleto && !window.cupoJuvenilesCompleto) {
            Swal.fire({
              title: "Cupo Principal Completo",
              text: "Ya tienes 25 jugadores. Solo puedes registrar jugadores menores de 15 años (cupos especiales).",
              icon: "warning",
              confirmButtonColor: "#28a745",
            });
            return;
          }
        }

        let campeonatoId = document.getElementById("campeonato").value;
        let teamData = {}; // Inicializamos teamData

        try {
            const teamDoc = await db.collection("teams").doc(teamId).get();
            if (teamDoc.exists) {
                teamData = teamDoc.data();
                // Si estamos en modo recalificar, obtener el campeonato del jugador original o usar el determinado al cargar
                if (mode === "reclassify") {
                    const selectedPlayerId = document.getElementById("playerSelector").value;
                    if (!selectedPlayerId) {
                        Swal.fire("Error", "Por favor seleccione un jugador para recalificar", "error");
                        return;
                    }
                    const oldPlayerDoc = await db.collection("players").doc(selectedPlayerId).get();

                    console.log("Datos del jugador antiguo seleccionado (oldPlayerDoc.data()):", oldPlayerDoc.data());
                    console.log("Datos del equipo (teamData):", teamData);

                    if (oldPlayerDoc.exists && oldPlayerDoc.data().campeonatoId) {
                        campeonatoId = oldPlayerDoc.data().campeonatoId;
                    } else if (teamData.championshipId) { // ¡Corregido! Usamos championshipId
                        campeonatoId = teamData.championshipId;
                    } else {
                        Swal.fire("Error", "No se pudo determinar el campeonato para la recalificación. Por favor, asegúrese de que el equipo o el jugador antiguo tengan un campeonato asociado.", "error");
                        return;
                    }
                }
            } else {
                Swal.fire("Error", "No se pudo obtener la información del equipo", "error");
                return;
            }
        } catch (error) {
            console.error("Error al obtener información del equipo o jugador antiguo:", error);
            Swal.fire("Error", "No se pudo obtener la información del equipo o jugador antiguo", "error");
            return;
        }

        if (!campeonatoId && mode !== "reclassify") { // Campeonato es requerido solo en modo registro si no es recalificación
            Swal.fire("Error", "Por favor seleccione un campeonato", "error");
            return;
        }

        // Obtener los valores de los campos y convertir a mayúsculas
        const nombres = document.getElementById("nombres").value.toUpperCase();
        const apellidos = document.getElementById("apellidos").value.toUpperCase();
        const cedula = document.getElementById("cedula").value.toUpperCase();
        const fechaNacimiento = document.getElementById("fechaNacimiento").value;
        const numeroJugador = document.getElementById("numeroJugador").value;

        // Crear el objeto con los datos del jugador
        const playerData = {
            teamId: teamId,
            teamName: teamData.name,
            teamCategory: teamData.category,
            nombres: nombres,
            apellidos: apellidos,
            cedula: cedula,
            fechaNacimiento: fechaNacimiento,
            numeroJugador: numeroJugador,
            playerPhoto: document.getElementById("playerPhotoPreview").src,
            cedulaPhoto: document.getElementById("cedulaPhotoPreview").src,
            campeonatoId: campeonatoId,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        };

        try {
            if (mode === "reclassify") {
                const selectedPlayerId = document.getElementById("playerSelector").value;
                // 1. Registrar al nuevo jugador con referencia al jugador que reemplazó
                const playerDataWithReplacement = {
                    ...playerData,
                    reemplazoDe: selectedPlayerId, // Campo para indicar que reemplazó a un jugador
                    fechaReemplazo: firebase.firestore.FieldValue.serverTimestamp()
                };
                const newPlayerDocRef = await db.collection("players").add(playerDataWithReplacement);
                console.log("Nuevo jugador registrado con ID:", newPlayerDocRef.id);

                // 2. Marcar al jugador antiguo como recalificado
                await db.collection("players").doc(selectedPlayerId).update({
                    status: "recalificado",
                    recalificadoPor: newPlayerDocRef.id, // Vincular al nuevo jugador
                    recalificacionFecha: firebase.firestore.FieldValue.serverTimestamp(),
                });
                console.log("Jugador antiguo marcado como recalificado:", selectedPlayerId);

                Swal.fire({
                    title: "¡Recalificación exitosa!",
                    text: "El jugador ha sido recalificado correctamente. El nuevo jugador ha sido registrado.",
                    icon: "success",
                    confirmButtonColor: "#28a745",
                }).then(() => {
                    loadPlayers();
                    document.getElementById("playerForm").reset();
                    document.getElementById("playerPhotoPreview").classList.add("d-none");
                    document.getElementById("playerPhotoText").classList.remove("d-none");
                    document.getElementById("cedulaPhotoPreview").classList.add("d-none");
                    document.getElementById("cedulaPhotoText").classList.remove("d-none");
                    document.getElementById("currentPlayerForm").style.display = "none";
                    document.getElementById("newPlayerForm").style.display = "none";
                    document.getElementById("playerSelector").value = ""; // Resetear el selector
                });

            } else { // Modo 'register'
                const docRef = await db.collection("players").add(playerData);
                console.log("Jugador registrado con ID:", docRef.id);
                Swal.fire({
                    title: "¡Registro exitoso!",
                    text: "El jugador ha sido registrado correctamente",
                    icon: "success",
                    confirmButtonColor: "#28a745",
                }).then(() => {
                    loadPlayers();
                    document.getElementById("playerForm").reset();
                    document.getElementById("playerPhotoPreview").classList.add("d-none");
                    document.getElementById("playerPhotoText").classList.remove("d-none");
                    document.getElementById("cedulaPhotoPreview").classList.add("d-none");
                    document.getElementById("cedulaPhotoText").classList.remove("d-none");
                });
            }
        } catch (error) {
            console.error("Error al registrar/recalificar jugador:", error);
            Swal.fire(
                "Error",
                "No se pudo completar la operación. Por favor, intenta de nuevo.",
                "error"
            );
        }
    });

      // Función para ver detalles del jugador
      window.viewPlayerDetails = function (playerId) {
        db.collection("players")
          .doc(playerId)
          .get()
          .then((doc) => {
            if (doc.exists) {
              const player = doc.data();

              document.getElementById("modalPlayerPhoto").src =
                player.playerPhoto;
              document.getElementById("modalCedulaPhoto").src =
                player.cedulaPhoto;
              document.getElementById("modalPlayerName").textContent =
                player.nombres;
              document.getElementById("modalPlayerApellido").textContent =
                player.apellidos;
              document.getElementById("modalPlayerCedula").textContent =
                player.cedula;
              document.getElementById("modalCedulaNumber").textContent =
                player.cedula;
              document.getElementById("modalPlayerNumero").textContent =
                player.numeroJugador;
              document.getElementById("modalTeamName").textContent =
                player.teamName;
              document.getElementById("modalTeamCategory").textContent =
                player.teamCategory;

              // Fecha de nacimiento y categoría
              const fechaNacimientoFormatted = formatDate(
                player.fechaNacimiento
              );
              const categoria = esJuvenil(player.fechaNacimiento)
                ? "Juvenil"
                : esMaster(player.fechaNacimiento)
                ? "Master"
                : "Senior";

              // Badge de la categoría según la edad
              let categoriaBadge = "";

              if (
                player.teamCategory.toLowerCase() === "primera" ||
                player.teamCategory.toLowerCase() === "máxima"
              ) {
                categoriaBadge =
                  categoria === "Juvenil"
                    ? '<span class="badge bg-success ms-2">JUVENIL</span>'
                    : categoria === "Master"
                    ? '<span class="badge bg-warning text-dark ms-2">MASTER</span>'
                    : '<span class="badge bg-primary ms-2">SENIOR</span>';
              }

              document.getElementById(
                "modalPlayerFechaNacimiento"
              ).innerHTML = `<strong style="color: black;">${fechaNacimientoFormatted}</strong> ${categoriaBadge}`;

              // Mostrar el modal
              const modal = new bootstrap.Modal(
                document.getElementById("playerModal")
              );
              modal.show();

              // Añadir/quitar clase de recalificado para la marca de agua
              const carnetContainer = document.querySelector("#playerModal .carnet-container");
              if (player.status === "recalificado") {
                  carnetContainer.classList.add("recalificado");

                  // Mostrar quién lo recalificó
                  if (player.recalificadoPor) {
                      db.collection("players").doc(player.recalificadoPor).get().then(newPlayerDoc => {
                          if (newPlayerDoc.exists) {
                              const newPlayer = newPlayerDoc.data();
                              const recalificadoPorText = document.createElement("p");
                              recalificadoPorText.innerHTML = `<strong>RECALIFICADO POR:</strong> <span style="color: black;">${newPlayer.nombres} ${newPlayer.apellidos}</span>`;
                              // Buscar el contenedor de información del carnet en el modal y añadir el texto
                              const carnetInfo = document.querySelector("#playerModal .carnet-info");
                              if (carnetInfo) {
                                  // Eliminar cualquier texto de recalificación existente antes de añadir uno nuevo
                                  const existingRecalificadoText = carnetInfo.querySelector(".recalificado-por-text");
                                  if (existingRecalificadoText) {
                                      existingRecalificadoText.remove();
                                  }
                                  recalificadoPorText.classList.add("recalificado-por-text"); // Para fácil identificación
                                  carnetInfo.appendChild(recalificadoPorText);
                              }
                          }
                      }).catch(error => {
                          console.error("Error al obtener datos del nuevo jugador para recalificación:", error);
                      });
                  }

              } else {
                  carnetContainer.classList.remove("recalificado");
                  // Remover el texto de recalificación si existe
                  const carnetInfo = document.querySelector("#playerModal .carnet-info");
                  if (carnetInfo) {
                      const existingRecalificadoText = carnetInfo.querySelector(".recalificado-por-text");
                      if (existingRecalificadoText) {
                          existingRecalificadoText.remove();
                      }
                  }
              }
            }
          })
          .catch((error) => {
            console.error("Error al cargar detalles del jugador:", error);
            Swal.fire(
              "Error",
              "No se pudieron cargar los detalles del jugador",
              "error"
            );
          });
      };

      // Función para calcular la edad
      function calcularEdad(fechaNacimiento) {
        const hoy = new Date();
        const fechaNac = new Date(fechaNacimiento);
        let edad = hoy.getFullYear() - fechaNac.getFullYear();
        const mes = hoy.getMonth() - fechaNac.getMonth();

        if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNac.getDate())) {
          edad--;
        }

        return edad;
      }

      // Función para verificar si es juvenil
      function esJuvenil(fechaNacimiento) {
        return calcularEdad(fechaNacimiento) < 18;
      }

      // Función para verificar si es juvenil menor de 15 años
      function esJuvenilMenor15(fechaNacimiento) {
        return calcularEdad(fechaNacimiento) < 15;
      }

      function esMaster(fechaNacimiento) {
        return calcularEdad(fechaNacimiento) > 40;
      }

      // Función para actualizar el contador de cupo
      function actualizarContadorCupo(jugadores) {
        let senior = 0;
        let menores15 = 0;
        let recalificados = 0;
        let nuevosJugadores = 0;

        jugadores.forEach(player => {
          if (player.status === "recalificado") {
            recalificados++;
          } else {
            // Verificar si este jugador reemplazó a un recalificado
            if (player.reemplazoDe) {
              nuevosJugadores++;
            }
            
            if (esJuvenilMenor15(player.fechaNacimiento)) {
              menores15++;
            } else {
              senior++;
            }
          }
        });

        const maxTotal = 27;
        const totalJugadores = senior + menores15;
        const totalRegistrados = senior + menores15 + recalificados; // Total incluyendo recalificados
        const faltanTotal = maxTotal - totalJugadores;

        // Actualizar contadores principales
        document.getElementById("jugadoresRegularesCount").textContent = senior;
        document.getElementById("jugadoresJuvenilesCount").textContent = menores15;
        document.getElementById("jugadoresTotalCount").textContent = totalJugadores;
        
        // Actualizar contador de total de jugadores registrados
        document.getElementById("jugadoresRegistradosTotalCount").textContent = totalRegistrados;

        // Actualizar contadores de recalificación (solo si estamos en modo reclassify)
        if (mode === "reclassify") {
          document.getElementById("jugadoresRecalificadosCount").textContent = recalificados;
          document.getElementById("jugadoresNuevosCount").textContent = nuevosJugadores;
          
          // Actualizar barras de progreso para recalificados
          const progresoRecalificados = recalificados > 0 ? 100 : 0;
          const progresoNuevos = nuevosJugadores > 0 ? 100 : 0;
          document.getElementById("jugadoresRecalificadosProgress").style.width = `${progresoRecalificados}%`;
          document.getElementById("jugadoresNuevosProgress").style.width = `${progresoNuevos}%`;
          
          // Actualizar estados de recalificados
          document.getElementById("jugadoresRecalificadosStatus").textContent = 
            recalificados > 0 ? `${recalificados} jugador${recalificados !== 1 ? 'es' : ''} marcado${recalificados !== 1 ? 's' : ''} como recalificado${recalificados !== 1 ? 's' : ''}` : "No hay jugadores recalificados";
          document.getElementById("jugadoresNuevosStatus").textContent = 
            nuevosJugadores > 0 ? `${nuevosJugadores} jugador${nuevosJugadores !== 1 ? 'es' : ''} que reemplazó${nuevosJugadores !== 1 ? 'ron' : ''} a recalificado${nuevosJugadores !== 1 ? 's' : ''}` : "No hay nuevos jugadores";
        }

        // Actualizar barras de progreso principales
        const progresoSenior = (senior / maxTotal) * 100;
        const progresoMenores = (menores15 / maxTotal) * 100;
        const progresoTotal = (totalJugadores / maxTotal) * 100;
        const progresoTotalRegistrados = (totalRegistrados / (maxTotal + recalificados)) * 100; // Progreso del total registrado
        document.getElementById("jugadoresRegularesProgress").style.width = `${Math.min(progresoSenior, 100)}%`;
        document.getElementById("jugadoresJuvenilesProgress").style.width = `${Math.min(progresoMenores, 100)}%`;
        document.getElementById("jugadoresTotalProgress").style.width = `${Math.min(progresoTotal, 100)}%`;
        document.getElementById("jugadoresRegistradosTotalProgress").style.width = `${Math.min(progresoTotalRegistrados, 100)}%`;

        // Actualizar estado del total de registrados
        document.getElementById("jugadoresRegistradosTotalStatus").textContent = 
          `Total: ${senior} senior + ${menores15} <15 + ${recalificados} recalificados = ${totalRegistrados} jugadores`;

        // Actualizar estados y alertas
        const cupoAlert = document.getElementById("cupoAlert");
        const cupoAlertText = document.getElementById("cupoAlertText");

        if (mode === "reclassify") {
          // Mostrar alerta especial para recalificación
          let mensaje = "";
          if (recalificados > 0) {
            mensaje += `<strong>Tienes ${recalificados} jugador${recalificados !== 1 ? 'es' : ''} recalificado${recalificados !== 1 ? 's' : ''}.</strong> `;
          } else {
            mensaje += `<strong>No tienes jugadores recalificados.</strong> `;
          }
          mensaje += `En total tienes <strong>${totalRegistrados} jugador${totalRegistrados !== 1 ? 'es' : ''} registrados</strong> en el equipo (calificados y recalificados).`;
          cupoAlert.className = "alert alert-info mt-3";
          cupoAlertText.innerHTML = mensaje;
          cupoAlert.style.display = "block";
        } else if (totalJugadores >= maxTotal) {
          cupoAlert.className = "alert alert-success mt-3";
          cupoAlertText.innerHTML = `<strong>¡Cupo completo!</strong> Tu equipo tiene el máximo de 27 jugadores permitidos. No puedes registrar más jugadores ni eliminarlos.`;
          cupoAlert.style.display = "block";
        } else {
          let mensaje = `<strong>Progreso del cupo:</strong> Tienes ${totalJugadores} jugador${totalJugadores !== 1 ? 'es' : ''} registrados: ${senior} senior y ${menores15} menor${menores15 !== 1 ? 'es' : ''} de 15 años. Te faltan ${faltanTotal} jugador${faltanTotal !== 1 ? 'es' : ''} para completar el máximo de 27.`;
          if (recalificados > 0) {
            mensaje += ` <strong>Total de jugadores en el equipo: ${totalRegistrados} (incluyendo ${recalificados} recalificado${recalificados !== 1 ? 's' : ''}).</strong>`;
          }
          cupoAlert.className = "alert alert-info mt-3";
          cupoAlertText.innerHTML = mensaje;
          cupoAlert.style.display = "block";
        }

        window.cupoCompleto = totalJugadores >= maxTotal;
        manejarEstadoFormulario();
      }

      // Función para cambiar el fondo del carnet
      function cambiarFondoCarnet() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";

        input.onchange = function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              const imageUrl = e.target.result;
              document.documentElement.style.setProperty(
                "--carnet-background",
                `url('${imageUrl}')`
              );

              // Mostrar mensaje de éxito
              Swal.fire({
                title: "¡Éxito!",
                text: "El fondo del carnet ha sido actualizado",
                icon: "success",
                confirmButtonColor: "#28a745",
              });
            };
            reader.readAsDataURL(file);
          }
        };

        input.click();
      }

      // Función para generar carnets
      function generarCarnets() {
        Swal.fire({
          title: "Ingrese la clave de administrador",
          input: "password",
          inputAttributes: {
            autocapitalize: "off",
          },
          showCancelButton: true,
          confirmButtonText: "Verificar",
          cancelButtonText: "Cancelar",
          showLoaderOnConfirm: true,
          preConfirm: (password) => {
            if (password !== "admin2025") {
              Swal.showValidationMessage("Clave incorrecta");
              return false;
            }
            return password;
          },
        }).then((result) => {
          if (result.isConfirmed) {
            db.collection("players")
              .where("teamId", "==", teamId)
              .get()
              .then((querySnapshot) => {
                const carnetsContainer =
                  document.getElementById("carnetsContainer");
                carnetsContainer.innerHTML = "";

                // Obtener el nombre del equipo
                db.collection("teams")
                  .doc(teamId)
                  .get()
                  .then((teamDoc) => {
                    const teamName = teamDoc.data().name;

                    // Filtrar jugadores según el modo
                    let jugadoresFiltrados = [];
                    if (mode === "reclassify") {
                      querySnapshot.forEach((doc) => {
                        const player = doc.data();
                        if (player.reemplazoDe) {
                          jugadoresFiltrados.push(player);
                        }
                      });
                    } else {
                      querySnapshot.forEach((doc) => {
                        const player = doc.data();
                        if (!player.reemplazoDe) {
                          jugadoresFiltrados.push(player);
                        }
                      });
                    }

                    jugadoresFiltrados.forEach((player) => {
                      const isRecalificado = player.status === "recalificado";
                      const carnetHtml = `
                      <div class="col-md-6">
                        <div class="carnet-moderno">
                          <div class="carnet-header">
                            <h6>LIGA BARRIAL ARGELIA ALTA</h6>
                            <p>CAMPEONATO 2025</p>
                          </div>
                          ${isRecalificado ? '<span class="carnet-recalificado-badge">RECALIFICADO</span>' : ''}
                          <div class="carnet-content">
                            <div class="carnet-photo-section">
                              <div class="carnet-photo-container">
                                <img src="${
                                  player.playerPhoto
                                }" alt="Foto del jugador">
                              </div>
                              <div class="carnet-numero-jugador">${
                                player.numeroJugador
                              }</div>
                            </div>
                            <div class="carnet-info">
                              <div class="team-name">${teamName}</div>
                              <p><strong>CATEGORIA:</strong> ${
                                player.teamCategory
                              }</p>
                              <p><strong>NOM:</strong> ${
                                player.nombres
                              }</p>
                              <p><strong>APELL:</strong> ${
                                player.apellidos
                              }</p>
                              <p><strong>FECHA NAC:</strong> ${formatDate(
                                player.fechaNacimiento
                              )}</p>
                              <p class="d-flex justify-content-between align-items-center">
                                <strong>CI:</strong> ${player.cedula}
                                ${
                                  esJuvenil(player.fechaNacimiento)
                                    ? '<span class="badge bg-light text-dark ms-5">JUVENIL</span>'
                                    : esMaster(player.fechaNacimiento)
                                    ? '<span class="badge bg-warning text-dark ms-5">MASTER</span>'
                                    : ""
                                }
                              </p>
                            </div>
                          </div>
                        </div>
                      </div>
                    `;
                      carnetsContainer.innerHTML += carnetHtml;
                    });

                    const modal = new bootstrap.Modal(
                      document.getElementById("carnetsModal")
                    );
                    modal.show();
                  });
              })
              .catch((error) => {
                console.error("Error al generar carnets:", error);
                Swal.fire(
                  "Error",
                  "No se pudieron generar los carnets. Por favor, intenta de nuevo.",
                  "error"
                );
              });
          }
        });
      }

      function imprimirCarnets() {
        const element = document.getElementById("carnetsContainer");
        const opt = {
          margin: 0.3,
          filename: "carnets_jugadores.pdf",
          image: { type: "jpeg", quality: 1 },
          html2canvas: {
            scale: 2,
            useCORS: true,
            allowTaint: true,
            backgroundColor: "#ffffff",
          },
          jsPDF: { unit: "cm", format: "a4", orientation: "portrait" },
        };

        // Generar el PDF
        html2pdf()
          .set(opt)
          .from(element)
          .save()
          .then(() => {
            // Cerrar el modal
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("carnetsModal")
            );
            modal.hide();

            Swal.fire({
              title: "¡Éxito!",
              text: "Los carnets se han generado correctamente",
              icon: "success",
              confirmButtonColor: "#28a745",
            });
          })
          .catch((err) => {
            console.error("Error al generar PDF:", err);
            Swal.fire({
              title: "Error",
              text: "No se pudo generar el PDF. Por favor, intenta de nuevo.",
              icon: "error",
            });
          });
      }

      // Función para formatear la fecha
      // Función para formatear la fecha sin afectar la zona horaria
      function formatDate(dateString) {
        const [year, month, day] = dateString.split("-");
        return `${day}/${month}/${year}`;
      }

      // Función para cargar jugadores para recalificación
      function loadPlayersForRecalification() {
        if (teamId) {
          db.collection("players")
            .where("teamId", "==", teamId)
            .get()
            .then((querySnapshot) => {
              const playerSelector = document.getElementById("playerSelector");
              playerSelector.innerHTML = '<option value="">Seleccione un jugador</option>';

              querySnapshot.forEach((doc) => {
                const player = doc.data();
                const option = document.createElement("option");
                option.value = doc.id;
                option.textContent = `${player.nombres} ${player.apellidos} - ${player.cedula}`;
                playerSelector.appendChild(option);
              });
            })
            .catch((error) => {
              console.error("Error al cargar jugadores:", error);
              Swal.fire("Error", "No se pudieron cargar los jugadores", "error");
            });
        }
      }

      // Agregar evento para cuando se seleccione un jugador
      document.getElementById("playerSelector").addEventListener("change", function(e) {
        const playerId = e.target.value;
        if (playerId) {
          db.collection("players")
            .doc(playerId)
            .get()
            .then((doc) => {
              if (doc.exists) {
                const player = doc.data();
                // Llenar el formulario del jugador actual
                document.getElementById("currentTeamName").value = player.teamName;
                document.getElementById("currentNombres").value = player.nombres;
                document.getElementById("currentApellidos").value = player.apellidos;
                document.getElementById("currentCedula").value = player.cedula;
                document.getElementById("currentFechaNacimiento").value = player.fechaNacimiento;
                document.getElementById("currentNumeroJugador").value = player.numeroJugador;
                
                // Mostrar las imágenes del jugador actual
                const currentPlayerPhotoPreview = document.getElementById("currentPlayerPhotoPreview");
                const currentCedulaPhotoPreview = document.getElementById("currentCedulaPhotoPreview");
                currentPlayerPhotoPreview.src = player.playerPhoto;
                currentCedulaPhotoPreview.src = player.cedulaPhoto;

                // Mostrar el formulario del jugador actual
                document.getElementById("currentPlayerForm").style.display = "block";
                document.getElementById("newPlayerForm").style.display = "block";

                // Limpiar el formulario del nuevo jugador
                document.getElementById("nombres").value = "";
                document.getElementById("apellidos").value = "";
                document.getElementById("cedula").value = "";
                document.getElementById("fechaNacimiento").value = "";
                document.getElementById("numeroJugador").value = "";
                
                // Ocultar las imágenes del formulario del nuevo jugador
                document.getElementById("playerPhotoPreview").classList.add("d-none");
                document.getElementById("playerPhotoText").classList.remove("d-none");
                document.getElementById("cedulaPhotoPreview").classList.add("d-none");
                document.getElementById("cedulaPhotoText").classList.remove("d-none");
              }
            })
            .catch((error) => {
              console.error("Error al cargar datos del jugador:", error);
              Swal.fire("Error", "No se pudieron cargar los datos del jugador", "error");
            });
        } else {
          // Si no hay jugador seleccionado, ocultar los formularios y resetear el formulario del nuevo jugador
          document.getElementById("currentPlayerForm").style.display = "none";
          document.getElementById("newPlayerForm").style.display = "none";
          document.getElementById("playerForm").reset(); // Limpiar el formulario del nuevo jugador
          document.getElementById("playerPhotoPreview").classList.add("d-none");
          document.getElementById("playerPhotoText").classList.remove("d-none");
          document.getElementById("cedulaPhotoPreview").classList.add("d-none");
          document.getElementById("cedulaPhotoText").classList.remove("d-none");
        }
      });

      // Función para manejar el estado del formulario según el cupo
      function manejarEstadoFormulario() {
        const form = document.getElementById("playerForm");
        const submitButton = document.getElementById("submitButton");
        
        // Solo bloquear el formulario si el cupo está completo y estamos en modo register
        if (window.cupoCompleto && mode === "register") {
          // Deshabilitar formulario completamente si el cupo total está completo
          form.style.pointerEvents = "none";
          form.style.opacity = "0.6";
          submitButton.disabled = true;
          submitButton.textContent = "Cupo Completo";
          
          // Agregar overlay de cupo completo
          let overlay = document.getElementById("cupoOverlay");
          if (!overlay) {
            overlay = document.createElement("div");
            overlay.id = "cupoOverlay";
            overlay.style.cssText = `
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(255, 255, 255, 0.9);
              display: flex;
              align-items: center;
              justify-content: center;
              z-index: 10;
              border-radius: 8px;
            `;
            overlay.innerHTML = `
              <div class="text-center">
                <i class="fas fa-users-slash text-muted" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <h5 class="text-muted">Cupo Completo</h5>
                <p class="text-muted mb-0">Máximo 27 jugadores alcanzado</p>
              </div>
            `;
            form.parentElement.style.position = "relative";
            form.parentElement.appendChild(overlay);
          }
        } else {
          // Habilitar formulario pero con validaciones específicas
          form.style.pointerEvents = "auto";
          form.style.opacity = "1";
          submitButton.disabled = false;
          submitButton.textContent = mode === "reclassify" ? "Recalificar Jugador" : "Registrar Jugador";
          
          // Mostrar SweetAlert con información del cupo disponible
          if (mode === "reclassify") {
            Swal.fire({
              title: "Cupo de Recalificación Disponible",
              text: "Puedes recalificar jugadores aunque el cupo esté completo. Los jugadores recalificados no cuentan para el cupo principal, pero sí para el total de registrados.",
              icon: "info",
              confirmButtonColor: "#28a745",
              timer: 4000,
              timerProgressBar: true
            });
          } else {
            Swal.fire({
              title: "Cupo Disponible",
              text: "Puedes registrar jugadores de cualquier edad. El cupo máximo es de 27 jugadores en total.",
              icon: "info",
              confirmButtonColor: "#28a745",
              timer: 4000,
              timerProgressBar: true
            });
          }
          
          // Remover overlay si existe
          const overlay = document.getElementById("cupoOverlay");
          if (overlay) {
            overlay.remove();
          }

          // Agregar validación en tiempo real para la fecha de nacimiento
          const fechaNacimientoInput = document.getElementById("fechaNacimiento");
          if (fechaNacimientoInput) {
            fechaNacimientoInput.addEventListener("change", validarFechaNacimiento);
          }
        }
      }

      // Función para validar la fecha de nacimiento en tiempo real
      function validarFechaNacimiento() {
        const fechaNacInput = document.getElementById("fechaNacimiento").value;
        const submitButton = document.getElementById("submitButton");
        
        if (fechaNacInput) {
          const esJuvenil = esJuvenilMenor15(fechaNacInput);
          
          if (esJuvenil && window.cupoJuvenilesCompleto && window.cupoRegularesCompleto) {
            // Si es juvenil pero ambos cupos están completos
            submitButton.disabled = true;
            submitButton.textContent = "Cupo Completo";
            Swal.fire({
              title: "Cupo Completo",
              text: "Ya tienes el máximo de jugadores permitidos. No puedes registrar más jugadores.",
              icon: "warning",
              confirmButtonColor: "#28a745",
            });
          } else if (esJuvenil && window.cupoJuvenilesCompleto && !window.cupoRegularesCompleto) {
            // Si es juvenil pero el cupo especial está completo, pero aún hay espacio en el principal
            submitButton.disabled = false;
            submitButton.textContent = mode === "reclassify" ? "Recalificar Jugador" : "Registrar Jugador";
            // No mostrar alerta, solo permitir el registro
          } else if (!esJuvenil && window.cupoRegularesCompleto && !window.cupoJuvenilesCompleto) {
            // Si es mayor de 15 pero el cupo principal está completo, solo permitir menores de 15
            submitButton.disabled = true;
            submitButton.textContent = "Solo Menores de 15";
            Swal.fire({
              title: "Cupo Principal Completo",
              text: "Ya tienes 25 jugadores. Solo puedes registrar jugadores menores de 15 años (cupos especiales).",
              icon: "warning",
              confirmButtonColor: "#28a745",
            });
          } else {
            // Cupo disponible para este tipo de jugador
            submitButton.disabled = false;
            submitButton.textContent = mode === "reclassify" ? "Recalificar Jugador" : "Registrar Jugador";
          }
        }
      }
    </script>

    <style>
      /* Estilos para el modal de ver jugador */
      .document-container {
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        flex-wrap: nowrap; /* no permite que salten de línea */
        gap: 10px;
        width: 100%;
        height: auto;
      }

      .carnet-container .cedula-container {
        border: 2px solid #28a745;
        border-radius: 12px;
        padding: -15px;
        background-color: #fff;
        box-shadow: 0 0 12px rgba(0, 0, 0, 0.08);
        width: 48%; /* ocupan lado a lado sin romper */
        box-sizing: border-box;
        /* height: 80%; */
      }

      .carnet-container {
        /* background:  */
        border-radius: 15px;
        padding: 20px;
        color: white;
        position: relative;
        overflow: hidden;
        margin-bottom: 20px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .carnet-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          45deg,
          transparent 0%,
          rgba(255, 255, 255, 0.1) 100%
        );
        pointer-events: none;
      }

      .carnet-header,
      .cedula-header {
        text-align: center;
        border-bottom: 2px solid #28a745;
        margin-bottom: 12px;
      }
      .carnet-header h3 {
        font-size: 1.5rem;
        margin: 0;
        background: linear-gradient(45deg, #28a745, #20c997);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: bold;
      }

      .carnet-photo-container {
        width: 150px;
        height: 200px;
        margin: 0 auto 20px;
        border-radius: 10px;
        overflow: hidden;
        border: 3px solid #28a745;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .carnet-photo-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .carnet-info {
        background: rgba(255, 255, 255, 0.1);
        padding: 1px;
        border-radius: 10px;
        margin-bottom: -1%;
      }

      .carnet-info p {
        margin: 5px 0;
        font-size: 0.9rem;
      }

      .carnet-info strong {
        color: #28a745;
      }

      .carnet-footer,
      .cedula-footer {
        text-align: center;
        font-size: 0.8rem;
        color: rgba(000);
        border-top: 1px solid #28a745;
        padding-top: 1px;
        margin-top: auto;
        font-style: italic;
        letter-spacing: 0.2px;
        width: 100%;
        background: transparent;
      }
      .carnet-footer p,
      .cedula-footer p {
        margin: 0;
      }

      /* Estilos para la marca de agua de recalificado (para el modal de ver detalles) */
      .carnet-container.recalificado {
        position: relative;
        overflow: hidden;
      }

      .carnet-container.recalificado::after {
        content: "RECALIFICADO";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
        font-size: 3em;
        font-weight: bold;
        color: rgba(255, 0, 0, 0.3);
        pointer-events: none;
        z-index: 10;
        white-space: nowrap;
      }

      /* Estilos para la generación de carnets */
      .carnet-moderno {
        background: var(
            --carnet-background,
            url("https://img.freepik.com/vector-premium/fondo-futbol-abstracto-jugador-futbol-pateando-pelota-otros-simbolos-deportivos-colores-verdes_444390-23654.jpg")
          )
          no-repeat center center;
        background-size: cover;
        border-radius: 16px;
        padding: 5px 15px 12px 10px;
        color: #222;
        position: relative;
        overflow: hidden;
        margin-bottom: 24px;
        box-shadow: 0 4px 18px rgba(40, 167, 69, 0.1);
        width: 7.55cm;
        height: 5.2cm;
        margin: 0 auto 24px;
        font-size: 0.9rem;
        display: flex;
        flex-direction: column;
        border: 1.5px solid #e0e0e0;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      /* Estilos para el badge de recalificado en carnets generados */
      .carnet-recalificado-badge {
        position: absolute;
        top: 50%; /* Centrado verticalmente */
        left: 50%; /* Centrado horizontalmente */
        transform: translate(-50%, -50%) rotate(-45deg); /* Centrado y rotado */
        background-color: rgba(220, 53, 69, 0.7); /* Rojo de Bootstrap con algo de transparencia */
        color: white;
        padding: 4px 10px; /* Ajuste el padding para un mejor aspecto */
        border-radius: 8px;
        font-size: 1.2em; /* Tamaño de fuente más grande para visibilidad */
        font-weight: bold;
        z-index: 10; /* Asegurarse de que esté visible */
        white-space: nowrap; /* Evitar que el texto se rompa */
      }

      .carnet-moderno .carnet-header {
        text-align: center;
        margin-bottom: 8px;
        position: relative;
        width: 100%;
        border-bottom: 1.5px solid #080404;
        padding-bottom: 4px;
      }

      .carnet-moderno .carnet-header h3 {
        font-size: 1.1rem;
        margin: 0;
        color: #0c0303;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1.2px;
      }

      .carnet-moderno .carnet-header p {
        font-size: 0.8rem;
        color: #000;
        margin: 2px 0 0 0;
        font-weight: 500;
      }

      #content {
        page-break-after: avoid;
        page-break-before: avoid;
        page-break-inside: avoid;
      }
      .carnet-moderno .carnet-content {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        flex: 1;
        margin: 0;
        padding: 0;
        background: none;
        border: none;
        border-radius: 0;
        box-shadow: none;
        overflow: visible;
        min-width: 0;
      }

      .carnet-moderno .carnet-photo-section {
        width: 70px;
        min-width: 70px;
        max-width: 70px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin-right: 18px;
        margin-top: 0;
      }

      .carnet-moderno .carnet-photo-container {
        width: 70px;
        height: 90px;
        border-radius: 10px;
        overflow: hidden;
        border: 2.5px solid #28a745;
        box-shadow: 0 2px 10px rgba(40, 167, 69, 0.1);
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .carnet-moderno .carnet-photo-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .carnet-moderno .carnet-numero-jugador {
        text-align: center;
        font-size: 1.1rem;
        font-weight: bold;
        color: #000;
        margin-top: -20px;
        letter-spacing: 1.2px;
        text-shadow: 0 1px 2px #e0e0e0;
      }

      .carnet-moderno .carnet-info {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        flex: 1;
        min-width: 0;
        padding: 0;
        background: transparent;
        box-shadow: none;
        border-radius: 0;
        min-height: 0;
        font-size: 0.72rem;
        word-break: break-word;
        overflow-wrap: break-word;
        line-height: 1.6; /* <<< aumenté el espacio entre líneas */
        margin-bottom: 0;
        margin-top: -1%;
      }

      .carnet-moderno .carnet-info p {
        margin: 0 0 0px 0;
        font-size: 0.65rem;
        line-height: 1.6;
        color: #000;
        word-break: break-word;
        overflow-wrap: break-word;
        max-width: 100%;
      }

      .carnet-moderno .carnet-info strong {
        color: #000;
        font-weight: 600;
        letter-spacing: 0.2px;
      }

      .carnet-moderno .carnet-footer {
        text-align: center;
        font-size: 0.7rem;
        color: #888;
        border-top: 1px solid #e0e0e0;
        padding-top: 4px;
        margin-top: auto;
        font-style: italic;
        letter-spacing: 0.2px;
        width: 100%;
      }

      .carnet-moderno .carnet-footer p {
        margin: 0;
      }

      @media print {
        .carnet-moderno {
          break-inside: avoid;
          page-break-inside: avoid;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
          background-color: #ffffff !important;
          background-image: var(--carnet-background) !important;
          background-size: cover !important;
          background-position: center !important;
          background-repeat: no-repeat !important;
        }
      }

      /* Estilos para el nombre del equipo en el carnet */
      .carnet-moderno .team-name {
        text-align: center;
        font-size: 0.84rem;
        font-weight: bold;
        color: #000;
        margin-top: 4px;
        text-transform: uppercase;
        letter-spacing: 1px;
        display: block;
        margin-left: auto;
        margin-right: auto;
      }

      /* Estilos para el contador de cupo */
      .cupo-card {
        transition: all 0.3s ease;
        border: 1px solid #e9ecef;
      }

      .cupo-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .cupo-card h6 {
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .cupo-card .h4 {
        font-weight: bold;
        color: #495057;
      }

      .progress {
        background-color: #e9ecef;
        border-radius: 10px;
      }

      .progress-bar {
        border-radius: 10px;
        transition: width 0.6s ease;
      }

      #cupoAlert {
        border-radius: 10px;
        border: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      #cupoAlert.alert-success {
        background-color: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
      }

      #cupoAlert.alert-warning {
        background-color: #fff3cd;
        color: #856404;
        border-left: 4px solid #ffc107;
      }

      #cupoAlert.alert-info {
        background-color: #d1ecf1;
        color: #0c5460;
        border-left: 4px solid #17a2b8;
      }

      /* Estilos específicos para contadores de recalificación */
      #recalificadosCounter .cupo-card {
        border: 2px solid transparent;
        position: relative;
        overflow: hidden;
      }

      #recalificadosCounter .cupo-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
        animation: shimmer 2s infinite;
        pointer-events: none;
      }

      @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
      }

      #recalificadosCounter .cupo-card.bg-warning {
        background: linear-gradient(135deg, #ffc107 0%, #ffca2c 100%) !important;
        border-color: #e0a800;
      }

      #recalificadosCounter .cupo-card.bg-danger {
        background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%) !important;
        border-color: #c82333;
      }

      #recalificadosCounter .cupo-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      #recalificadosCounter .cupo-card .h4 {
        font-size: 2rem;
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      #recalificadosCounter .cupo-card.bg-warning .h4 {
        color: #856404;
      }

      #recalificadosCounter .cupo-card.bg-danger .h4 {
        color: white;
      }

      #recalificadosCounter .cupo-card small {
        font-weight: 500;
        font-size: 0.85rem;
      }

      /* Estilos específicos para el contador de total de jugadores registrados */
      .cupo-card.bg-dark {
        background: linear-gradient(135deg, #343a40 0%, #495057 100%) !important;
        border-color: #212529;
        position: relative;
        overflow: hidden;
      }

      .cupo-card.bg-dark::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.05) 50%, transparent 70%);
        animation: shimmer 3s infinite;
        pointer-events: none;
      }

      .cupo-card.bg-dark:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        background: linear-gradient(135deg, #495057 0%, #6c757d 100%) !important;
      }

      .cupo-card.bg-dark .h4 {
        font-size: 2.5rem;
        font-weight: 700;
        color: white;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .cupo-card.bg-dark h6 {
        color: #f8f9fa;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }

      .cupo-card.bg-dark small {
        color: #dee2e6;
        font-weight: 500;
        font-size: 0.9rem;
      }

      .cupo-card.bg-dark .text-light {
        color: #adb5bd !important;
        font-size: 0.85rem;
        font-weight: 500;
      }

      .cupo-card.bg-dark .progress-bar.bg-warning {
        background: linear-gradient(90deg, #ffc107 0%, #ffca2c 100%) !important;
        box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
      }
    </style>
  </body>
</html>
