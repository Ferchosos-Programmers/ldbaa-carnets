<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard de Programación | Liga Barrial</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/responsive.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>
      body {
        background-color: #f1f1f1;
        font-family: 'Times New Roman', Times, serif;
      }
      .navbar {
        background-color: #28a745;
      }
      .navbar-brand {
        font-weight: bold;
        font-size: 1.5rem;
        color: #fff !important;
      }
      .card {
        transition: transform 0.2s ease-in-out;
        border-radius: 1rem;
      }
      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      }
      .card-title {
        color: #28a745;
        font-weight: 600;
      }
      .modal-header {
        background-color: #28a745;
        color: white;
        border-top-left-radius: 0.5rem;
        border-top-right-radius: 0.5rem;
      }
      .table-container {
        overflow-x: auto;
      }
      .category-tabs {
        margin-bottom: 20px;
      }
      .category-tabs .nav-link {
        color: #28a745;
        border: 2px solid #28a745;
        margin-right: 10px;
        border-radius: 20px;
      }
      .category-tabs .nav-link.active {
        background-color: #28a745;
        color: white;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <nav class="navbar navbar-expand-lg shadow-sm px-4">
      <div class="container-fluid">
        <a class="navbar-brand text-white fw-bold d-flex align-items-center" href="dashboard.html">
          <img src="img/logo.png" alt="Logo" width="30" height="30" class="me-2" />
          LIGA BARRIAL ARGELIA ALTA
        </a>
        <button class="btn btn-xs btn-danger ms-auto text-white fw-semibold" onclick="logout()" style="border-radius: 50px">
          <i class="bi bi-box-arrow-right me-1"></i> Cerrar sesión
        </button>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-dark">🏆 Gestión de Campeonatos</h3>
        <div>
          <button class="btn btn-success shadow" data-bs-toggle="modal" data-bs-target="#addResultModal">
            + Registrar Resultado
          </button>
        </div>
      </div>

      <!-- Selector de Campeonato -->
      <div class="mb-4">
        <label for="championshipSelect" class="form-label">Seleccionar Campeonato:</label>
        <select class="form-select" id="championshipSelect" onchange="onChampionshipSelected()">
          <option value="">Cargando campeonatos...</option>
        </select>
      </div>

      <!-- Pestañas de categorías -->
      <ul class="nav nav-pills category-tabs" id="categoryTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="maxima-tab" data-bs-toggle="pill" data-bs-target="#maxima" type="button" role="tab">Máxima</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="primera-tab" data-bs-toggle="pill" data-bs-target="#primera" type="button" role="tab">Primera</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="femenino-tab" data-bs-toggle="pill" data-bs-target="#femenino" type="button" role="tab">Femenino</button>
        </li>
      </ul>

      <!-- Contenido de las pestañas -->
      <div class="tab-content" id="categoryTabContent">
        <div class="tab-pane fade show active" id="maxima" role="tabpanel">
          <div class="table-container">
            <table class="table table-striped table-hover">
              <thead class="table-success">
                <tr>
                  <th>Pos</th>
                  <th>Equipo</th>
                  <th>PJ</th>
                  <th>PG</th>
                  <th>PE</th>
                  <th>PP</th>
                  <th>GF</th>
                  <th>GC</th>
                  <th>DG</th>
                  <th>Pts</th>
                </tr>
              </thead>
              <tbody id="maximaTableBody">
                <!-- Se llenará dinámicamente -->
              </tbody>
            </table>
          </div>
        </div>
        <div class="tab-pane fade" id="primera" role="tabpanel">
          <div class="table-container">
            <table class="table table-striped table-hover">
              <thead class="table-success">
                <tr>
                  <th>Pos</th>
                  <th>Equipo</th>
                  <th>PJ</th>
                  <th>PG</th>
                  <th>PE</th>
                  <th>PP</th>
                  <th>GF</th>
                  <th>GC</th>
                  <th>DG</th>
                  <th>Pts</th>
                </tr>
              </thead>
              <tbody id="primeraTableBody">
                <!-- Se llenará dinámicamente -->
              </tbody>
            </table>
          </div>
        </div>
        <div class="tab-pane fade" id="femenino" role="tabpanel">
          <div class="table-container">
            <table class="table table-striped table-hover">
              <thead class="table-success">
                <tr>
                  <th>Pos</th>
                  <th>Equipo</th>
                  <th>PJ</th>
                  <th>PG</th>
                  <th>PE</th>
                  <th>PP</th>
                  <th>GF</th>
                  <th>GC</th>
                  <th>DG</th>
                  <th>Pts</th>
                </tr>
              </thead>
              <tbody id="femeninoTableBody">
                <!-- Se llenará dinámicamente -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para registrar resultados -->
    <div class="modal fade" id="addResultModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Registrar Resultado</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="resultForm">
              <div class="mb-3">
                <label for="localTeam" class="form-label">Equipo Local</label>
                <select class="form-select" id="localTeam" required>
                  <option value="">Seleccionar equipo local</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="awayTeam" class="form-label">Equipo Visitante</label>
                <select class="form-select" id="awayTeam" required>
                  <option value="">Seleccionar equipo visitante</option>
                </select>
              </div>
              <div class="row">
                <div class="col-6">
                  <div class="mb-3">
                    <label for="localGoals" class="form-label">Goles Local</label>
                    <input type="number" class="form-control" id="localGoals" min="0" required>
                  </div>
                </div>
                <div class="col-6">
                  <div class="mb-3">
                    <label for="awayGoals" class="form-label">Goles Visitante</label>
                    <input type="number" class="form-control" id="awayGoals" min="0" required>
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label for="matchDate" class="form-label">Fecha del Partido</label>
                <input type="datetime-local" class="form-control" id="matchDate" required>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-success" onclick="saveResult()">Guardar Resultado</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap y Firebase -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-auth.js"></script>

    <script>
      // Configuración de Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyAzRTlx96sL8rxcgLauftrTWpr5VlwjV00",
        authDomain: "ldbaa-calificaciones.firebaseapp.com",
        projectId: "ldbaa-calificaciones",
        storageBucket: "ldbaa-calificaciones.firebasestorage.app",
        messagingSenderId: "277579489603",
        appId: "1:277579489603:web:bc93c22fea5f5f6b63cff6"
      };

      // Inicializar Firebase
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }

      const db = firebase.firestore();
      const auth = firebase.auth();

      // Verificar autenticación
      auth.onAuthStateChanged((user) => {
        if (!user || user.email !== 'programacion@gmail.com') {
          window.location.href = 'login.html';
          return;
        }
        loadChampionships();
      });

      // Variables globales
      let currentChampionship = null;
      let currentCategory = 'maxima';

      // Cargar campeonatos
      function loadChampionships() {
        const championshipSelect = document.getElementById('championshipSelect');
        championshipSelect.innerHTML = '<option value="">Seleccionar un campeonato...</option>';

        db.collection('championships').get().then((querySnapshot) => {
          if (querySnapshot.empty) {
            championshipSelect.innerHTML = '<option value="">No hay campeonatos disponibles</option>';
            return;
          }
          querySnapshot.forEach((doc) => {
            const championship = doc.data();
            championship.id = doc.id;
            const option = document.createElement('option');
            option.value = doc.id;
            option.textContent = `${championship.name}`;
            championshipSelect.appendChild(option);
          });
          // Seleccionar el primer campeonato por defecto si hay alguno
          if (championshipSelect.options.length > 1) {
            championshipSelect.value = championshipSelect.options[1].value;
            onChampionshipSelected();
          }
        }).catch(error => {
          console.error("Error al cargar campeonatos:", error);
          championshipSelect.innerHTML = '<option value="">Error al cargar campeonatos</option>';
        });
      }

      // Función que se ejecuta al seleccionar un campeonato
      function onChampionshipSelected() {
        const championshipId = document.getElementById('championshipSelect').value;
        console.log('Campeonato seleccionado ID:', championshipId);

        if (!championshipId) {
          // Limpiar las tablas si no hay campeonato seleccionado
          document.getElementById('maximaTableBody').innerHTML = '';
          document.getElementById('primeraTableBody').innerHTML = '';
          document.getElementById('femeninoTableBody').innerHTML = '';
          currentChampionship = null;
          return;
        }

        db.collection('championships').doc(championshipId).get().then((doc) => {
          if (doc.exists) {
            currentChampionship = { id: doc.id, ...doc.data() };
            console.log('Información del campeonato actual:', currentChampionship);
            // Cargar los equipos para la categoría actual del campeonato seleccionado
            loadTeamsForChampionship(currentChampionship.id, currentCategory);
          } else {
            Swal.fire('Error', 'Campeonato no encontrado', 'error');
            currentChampionship = null;
          }
        }).catch(error => {
          console.error("Error al obtener campeonato:", error);
          Swal.fire('Error', 'No se pudo cargar la información del campeonato', 'error');
          currentChampionship = null;
        });
      }

      // Cargar equipos para un campeonato y categoría específica
      function loadTeamsForChampionship(championshipId, category) {
        console.log(`Cargando equipos para Campeonato ID: ${championshipId} y Categoría: ${category}`);
        // Limpiar la tabla de la categoría actual
        document.getElementById(`${category}TableBody`).innerHTML = '';

        db.collection('teams')
          .where('championshipId', '==', championshipId)
          .get()
          .then((querySnapshot) => {
            let teams = [];
            querySnapshot.forEach((doc) => {
              const team = doc.data();
              team.id = doc.id;
              teams.push(team);
            });
            console.log('Equipos cargados desde Firestore (antes de filtrar por categoría):', teams);

            // Filtramos por categoría en JavaScript, haciendo la comparación insensible a mayúsculas/minúsculas y a acentos
            const filteredTeams = teams.filter(team => {
              const teamCategory = team.category ? team.category.normalize("NFD").replace(/[̀-ͯ]/g, "").toLowerCase() : '';
              const selectedCategory = category.normalize("NFD").replace(/[̀-ͯ]/g, "").toLowerCase();
              console.log(`Comparando equipo: ${team.name}, Categoría del equipo (normalizada): ${teamCategory}, Categoría seleccionada (normalizada): ${selectedCategory}`);
              return teamCategory === selectedCategory;
            });
            console.log('Equipos filtrados por categoría:', filteredTeams);

            // Ordenar equipos por puntos y diferencia de goles
            filteredTeams.sort((a, b) => {
              if (b.points !== a.points) return b.points - a.points;
              return (b.goalsFor - b.goalsAgainst) - (a.goalsFor - a.goalsAgainst);
            });

            // Actualizar la tabla correspondiente
            updateTable(category, filteredTeams);
          }).catch(error => {
            console.error("Error al cargar equipos:", error);
            Swal.fire('Error', 'No se pudieron cargar los equipos', 'error');
          });
      }

      // Actualizar tabla de posiciones
      function updateTable(category, teams) {
        const tableBody = document.getElementById(`${category}TableBody`);
        if (!tableBody) return;

        tableBody.innerHTML = teams.map((team, index) => `
          <tr>
            <td>${index + 1}</td>
            <td>${team.name}</td>
            <td>${team.played || 0}</td>
            <td>${team.won || 0}</td>
            <td>${team.drawn || 0}</td>
            <td>${team.lost || 0}</td>
            <td>${team.goalsFor || 0}</td>
            <td>${team.goalsAgainst || 0}</td>
            <td>${(team.goalsFor || 0) - (team.goalsAgainst || 0)}</td>
            <td>${team.points || 0}</td>
          </tr>
        `).join('');
      }

      // Función para actualizar resultados
      function updateResults(teamId, championshipId, result) {
        const batch = db.batch();
        const teamRef = db.collection('teams').doc(teamId);
        const championshipRef = db.collection('championships').doc(championshipId);

        // Actualizar estadísticas del equipo
        batch.update(teamRef, {
          played: firebase.firestore.FieldValue.increment(1),
          won: firebase.firestore.FieldValue.increment(result.won ? 1 : 0),
          drawn: firebase.firestore.FieldValue.increment(result.drawn ? 1 : 0),
          lost: firebase.firestore.FieldValue.increment(result.lost ? 1 : 0),
          goalsFor: firebase.firestore.FieldValue.increment(result.goalsFor),
          goalsAgainst: firebase.firestore.FieldValue.increment(result.goalsAgainst),
          points: firebase.firestore.FieldValue.increment(result.points)
        });

        return batch.commit();
      }

      // Función para cerrar sesión
      function logout() {
        Swal.fire({
          title: '¿Cerrar sesión?',
          text: "¿Estás seguro de que deseas salir?",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#28a745',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Sí, salir',
          cancelButtonText: 'Cancelar'
        }).then((result) => {
          if (result.isConfirmed) {
            auth.signOut().then(() => {
              window.location.href = 'login.html';
            }).catch((error) => {
              console.error("Error al cerrar sesión:", error);
              Swal.fire('Error', 'No se pudo cerrar la sesión', 'error');
            });
          }
        });
      }

      // Cargar equipos para el modal de resultados
      function loadTeamsForResultModal(championshipId, category) {
        console.log(`Cargando equipos para modal de resultados - Campeonato ID: ${championshipId}, Categoría: ${category}`);
        const localTeamSelect = document.getElementById('localTeam');
        const awayTeamSelect = document.getElementById('awayTeam');
        
        // Limpiar opciones actuales
        localTeamSelect.innerHTML = '<option value="">Seleccionar equipo local</option>';
        awayTeamSelect.innerHTML = '<option value="">Seleccionar equipo visitante</option>';

        // Cargar equipos del campeonato actual
        db.collection('teams')
          .where('championshipId', '==', championshipId)
          .get()
          .then((querySnapshot) => {
            let teams = [];
            querySnapshot.forEach((doc) => {
              const team = doc.data();
              team.id = doc.id;
              teams.push(team);
            });
            console.log('Equipos para modal cargados desde Firestore (antes de filtrar por categoría):', teams);

            // Filtramos por categoría en JavaScript, haciendo la comparación insensible a mayúsculas/minúsculas y a acentos
            const filteredTeams = teams.filter(team => {
              const teamCategory = team.category ? team.category.normalize("NFD").replace(/[̀-ͯ]/g, "").toLowerCase() : '';
              const selectedCategory = category.normalize("NFD").replace(/[̀-ͯ]/g, "").toLowerCase();
              console.log(`Modal - Comparando equipo: ${team.name}, Categoría del equipo (normalizada): ${teamCategory}, Categoría seleccionada (normalizada): ${selectedCategory}`);
              return teamCategory === selectedCategory;
            });
            console.log('Modal - Equipos filtrados por categoría:', filteredTeams);

            if (filteredTeams.length === 0) {
              localTeamSelect.innerHTML = '<option value="">No hay equipos en esta categoría para el campeonato actual</option>';
              awayTeamSelect.innerHTML = '<option value="">No hay equipos en esta categoría para el campeonato actual</option>';
              return;
            }
            filteredTeams.forEach((team) => {
              const option = `<option value="${team.id}">${team.name}</option>`;
              localTeamSelect.innerHTML += option;
              awayTeamSelect.innerHTML += option;
            });
          }).catch(error => {
            console.error("Error al cargar equipos para el modal de resultados:", error);
            Swal.fire('Error', 'No se pudieron cargar los equipos para el formulario de resultados', 'error');
          });
      }

      // Guardar resultado
      function saveResult() {
        const localTeamId = document.getElementById('localTeam').value;
        const awayTeamId = document.getElementById('awayTeam').value;
        const localGoals = parseInt(document.getElementById('localGoals').value);
        const awayGoals = parseInt(document.getElementById('awayGoals').value);
        const matchDate = document.getElementById('matchDate').value;

        if (!localTeamId || !awayTeamId || localTeamId === awayTeamId) {
          Swal.fire('Error', 'Selecciona equipos diferentes', 'error');
          return;
        }

        // Calcular puntos y estadísticas
        const localResult = {
          won: localGoals > awayGoals,
          drawn: localGoals === awayGoals,
          lost: localGoals < awayGoals,
          goalsFor: localGoals,
          goalsAgainst: awayGoals,
          points: localGoals > awayGoals ? 3 : (localGoals === awayGoals ? 1 : 0)
        };

        const awayResult = {
          won: awayGoals > localGoals,
          drawn: localGoals === awayGoals,
          lost: awayGoals < localGoals,
          goalsFor: awayGoals,
          goalsAgainst: localGoals,
          points: awayGoals > localGoals ? 3 : (localGoals === awayGoals ? 1 : 0)
        };

        // Actualizar resultados
        Promise.all([
          updateResults(localTeamId, currentChampionship.id, localResult),
          updateResults(awayTeamId, currentChampionship.id, awayResult)
        ]).then(() => {
          // Guardar el partido en la colección de partidos
          db.collection('matches').add({
            championshipId: currentChampionship.id,
            localTeamId,
            awayTeamId,
            localGoals,
            awayGoals,
            date: new Date(matchDate),
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          }).then(() => {
            Swal.fire({
              title: 'Éxito',
              text: 'Resultado guardado correctamente',
              icon: 'success'
            });
            document.getElementById('resultForm').reset();
            bootstrap.Modal.getInstance(document.getElementById('addResultModal')).hide();
            loadChampionships();
          });
        }).catch((error) => {
          console.error("Error al guardar resultado:", error);
          Swal.fire('Error', 'No se pudo guardar el resultado', 'error');
        });
      }

      // Cambiar de categoría
      document.querySelectorAll('.category-tabs .nav-link').forEach(tab => {
        tab.addEventListener('click', (e) => {
          currentCategory = e.target.id.replace('-tab', '');
          console.log('Pestaña de categoría seleccionada:', currentCategory);
          if (currentChampionship) {
            loadTeamsForChampionship(currentChampionship.id, currentCategory);
            loadTeamsForResultModal(currentChampionship.id, currentCategory);
          }
        });
      });

      // Asegurarse de cargar los equipos en el modal cuando se abre
      document.getElementById('addResultModal').addEventListener('show.bs.modal', () => {
        if (currentChampionship) {
          loadTeamsForResultModal(currentChampionship.id, currentCategory);
        } else {
          Swal.fire('Información', 'Por favor, selecciona un campeonato primero.', 'info');
        }
      });
    </script>
  </body>
</html> 